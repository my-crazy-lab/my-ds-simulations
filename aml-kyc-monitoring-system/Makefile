# AML/KYC Monitoring System Makefile
# Comprehensive build, test, and deployment automation

.PHONY: help build test clean deploy docker-build docker-up docker-down \
        run-tests run-integration-tests run-database-tests run-monitoring-tests \
        setup-dev install-deps format lint security-scan \
        start-services stop-services restart-services \
        backup-data restore-data migrate-schema \
        load-test stress-test benchmark \
        deploy-staging deploy-production \
        monitor-health check-compliance generate-reports

# Default target
help: ## Show this help message
	@echo "AML/KYC Monitoring System - Available Commands:"
	@echo "================================================"
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "\033[36m%-30s\033[0m %s\n", $$1, $$2}'

# Build targets
build: ## Build all services
	@echo "ðŸ”¨ Building AML/KYC monitoring services..."
	cd services/aml-engine && go build -o ../../bin/aml-engine .
	@echo "âœ… Build completed"

build-docker: ## Build Docker images
	@echo "ðŸ³ Building Docker images..."
	docker-compose build
	@echo "âœ… Docker images built"

# Test targets
test: ## Run all tests
	@echo "ðŸ§ª Running all tests..."
	$(MAKE) run-database-tests
	$(MAKE) run-monitoring-tests
	$(MAKE) run-integration-tests
	@echo "âœ… All tests completed"

run-database-tests: ## Run database-specific tests
	@echo "ðŸ—„ï¸ Running database tests..."
	cd tests/database && python -m pytest test_graph_analytics_streaming.py -v
	@echo "âœ… Database tests completed"

run-monitoring-tests: ## Run monitoring tests
	@echo "ðŸ“Š Running monitoring tests..."
	cd tests/monitoring && python -m pytest -v
	@echo "âœ… Monitoring tests completed"

run-integration-tests: ## Run integration tests
	@echo "ðŸ”— Running integration tests..."
	cd tests && python -m pytest integration/ -v
	@echo "âœ… Integration tests completed"

run-load-tests: ## Run load tests
	@echo "âš¡ Running load tests..."
	k6 run tests/k6/aml-load-test.js
	@echo "âœ… Load tests completed"

# Development targets
setup-dev: ## Setup development environment
	@echo "ðŸ› ï¸ Setting up development environment..."
	$(MAKE) install-deps
	$(MAKE) setup-database
	@echo "âœ… Development environment ready"

install-deps: ## Install dependencies
	@echo "ðŸ“¦ Installing dependencies..."
	go mod tidy
	pip install -r requirements-test.txt
	@echo "âœ… Dependencies installed"

format: ## Format code
	@echo "ðŸŽ¨ Formatting code..."
	go fmt ./...
	black tests/
	@echo "âœ… Code formatted"

lint: ## Run linters
	@echo "ðŸ” Running linters..."
	golangci-lint run ./...
	flake8 tests/
	@echo "âœ… Linting completed"

security-scan: ## Run security scans
	@echo "ðŸ”’ Running security scans..."
	gosec ./...
	safety check -r requirements-test.txt
	@echo "âœ… Security scan completed"

# Docker targets
docker-up: ## Start Docker services
	@echo "ðŸš€ Starting Docker services..."
	docker-compose up -d
	@echo "âœ… Services started"

docker-down: ## Stop Docker services
	@echo "ðŸ›‘ Stopping Docker services..."
	docker-compose down
	@echo "âœ… Services stopped"

docker-logs: ## View Docker logs
	docker-compose logs -f

docker-ps: ## Show running containers
	docker-compose ps

# Service management
start-services: ## Start all services
	@echo "ðŸš€ Starting AML/KYC services..."
	$(MAKE) docker-up
	@echo "âœ… Services started"

stop-services: ## Stop all services
	@echo "ðŸ›‘ Stopping AML/KYC services..."
	$(MAKE) docker-down
	@echo "âœ… Services stopped"

restart-services: ## Restart all services
	@echo "ðŸ”„ Restarting services..."
	$(MAKE) stop-services
	$(MAKE) start-services
	@echo "âœ… Services restarted"

# Database management
setup-database: ## Setup database
	@echo "ðŸ—„ï¸ Setting up database..."
	docker-compose up -d postgres redis neo4j
	sleep 10
	$(MAKE) migrate-schema
	@echo "âœ… Database setup completed"

migrate-schema: ## Run database migrations
	@echo "ðŸ“Š Running database migrations..."
	cd services/aml-engine && go run migrations/*.go
	@echo "âœ… Migrations completed"

backup-data: ## Backup database
	@echo "ðŸ’¾ Backing up database..."
	docker-compose exec postgres pg_dump -U aml_user aml_db > backup_$(shell date +%Y%m%d_%H%M%S).sql
	@echo "âœ… Backup completed"

restore-data: ## Restore database from backup
	@echo "ðŸ”„ Restoring database..."
	@read -p "Enter backup file path: " backup_file; \
	docker-compose exec -T postgres psql -U aml_user aml_db < $$backup_file
	@echo "âœ… Restore completed"

# Monitoring and health checks
monitor-health: ## Check service health
	@echo "ðŸ¥ Checking service health..."
	curl -f http://localhost:8080/health || echo "âŒ AML Engine unhealthy"
	curl -f http://localhost:9090/api/v1/query?query=up || echo "âŒ Prometheus unhealthy"
	@echo "âœ… Health check completed"

check-compliance: ## Run compliance checks
	@echo "ðŸ“‹ Running compliance checks..."
	cd tests && python -m pytest compliance/ -v
	@echo "âœ… Compliance checks completed"

generate-reports: ## Generate monitoring reports
	@echo "ðŸ“Š Generating reports..."
	cd scripts && python generate_aml_report.py
	@echo "âœ… Reports generated"

# Performance testing
load-test: ## Run load tests
	@echo "âš¡ Running load tests..."
	k6 run --vus 50 --duration 5m tests/k6/aml-load-test.js
	@echo "âœ… Load test completed"

stress-test: ## Run stress tests
	@echo "ðŸ’ª Running stress tests..."
	k6 run --vus 100 --duration 10m tests/k6/aml-stress-test.js
	@echo "âœ… Stress test completed"

benchmark: ## Run benchmarks
	@echo "ðŸƒ Running benchmarks..."
	cd services/aml-engine && go test -bench=. -benchmem
	@echo "âœ… Benchmarks completed"

# Deployment targets
deploy-staging: ## Deploy to staging
	@echo "ðŸš€ Deploying to staging..."
	docker-compose -f docker-compose.staging.yml up -d
	@echo "âœ… Staging deployment completed"

deploy-production: ## Deploy to production
	@echo "ðŸš€ Deploying to production..."
	@echo "âš ï¸  Production deployment requires manual approval"
	@read -p "Are you sure you want to deploy to production? (y/N): " confirm; \
	if [ "$$confirm" = "y" ] || [ "$$confirm" = "Y" ]; then \
		docker-compose -f docker-compose.prod.yml up -d; \
		echo "âœ… Production deployment completed"; \
	else \
		echo "âŒ Production deployment cancelled"; \
	fi

# Cleanup targets
clean: ## Clean build artifacts
	@echo "ðŸ§¹ Cleaning build artifacts..."
	rm -rf bin/
	rm -rf __pycache__/
	rm -rf .pytest_cache/
	docker system prune -f
	@echo "âœ… Cleanup completed"

clean-data: ## Clean all data (WARNING: destructive)
	@echo "âš ï¸  WARNING: This will delete all data!"
	@read -p "Are you sure? (y/N): " confirm; \
	if [ "$$confirm" = "y" ] || [ "$$confirm" = "Y" ]; then \
		docker-compose down -v; \
		docker volume prune -f; \
		echo "âœ… Data cleanup completed"; \
	else \
		echo "âŒ Data cleanup cancelled"; \
	fi

# Development utilities
dev-shell: ## Open development shell
	docker-compose exec aml-engine /bin/bash

logs: ## View service logs
	docker-compose logs -f aml-engine

tail-logs: ## Tail service logs
	docker-compose logs -f --tail=100

# Documentation
docs: ## Generate documentation
	@echo "ðŸ“š Generating documentation..."
	cd docs && make html
	@echo "âœ… Documentation generated"

# Quick commands
quick-test: ## Quick test run
	cd tests/database && python -m pytest test_graph_analytics_streaming.py::TestGraphAnalyticsStreaming::test_streaming_enrichment_accuracy -v

quick-start: ## Quick start for development
	$(MAKE) docker-up
	sleep 15
	$(MAKE) monitor-health

# CI/CD helpers
ci-test: ## Run tests in CI environment
	@echo "ðŸ¤– Running CI tests..."
	$(MAKE) lint
	$(MAKE) security-scan
	$(MAKE) test
	@echo "âœ… CI tests completed"

ci-build: ## Build in CI environment
	@echo "ðŸ¤– Running CI build..."
	$(MAKE) build
	$(MAKE) build-docker
	@echo "âœ… CI build completed"

# Version management
version: ## Show version information
	@echo "AML/KYC Monitoring System v1.0.0"
	@echo "Go version: $(shell go version)"
	@echo "Docker version: $(shell docker --version)"
	@echo "Python version: $(shell python --version)"

# Default development workflow
dev: ## Start development workflow
	$(MAKE) setup-dev
	$(MAKE) quick-start
	$(MAKE) quick-test
