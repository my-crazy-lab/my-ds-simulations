# Fraud Detection Insurance Makefile
# ML-powered fraud detection for insurance claims

.PHONY: help build test clean deploy docker-build docker-up docker-down \
        run-tests run-ml-tests run-database-tests run-graph-tests \
        setup-dev install-deps format lint security-scan \
        start-services stop-services restart-services \
        backup-data restore-data migrate-schema \
        train-models deploy-models validate-models \
        deploy-staging deploy-production \
        monitor-health check-performance generate-reports

# Default target
help: ## Show this help message
	@echo "Fraud Detection Insurance - Available Commands:"
	@echo "=============================================="
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "\033[36m%-30s\033[0m %s\n", $$1, $$2}'

# Build targets
build: ## Build all fraud detection services
	@echo "ðŸ”¨ Building fraud detection services..."
	cd services/fraud-detection-engine && go build -o ../../bin/fraud-detection-engine .
	@echo "âœ… Build completed"

build-docker: ## Build Docker images
	@echo "ðŸ³ Building Docker images..."
	docker-compose build
	@echo "âœ… Docker images built"

# Test targets
test: ## Run all tests
	@echo "ðŸ§ª Running all tests..."
	$(MAKE) run-database-tests
	$(MAKE) run-ml-tests
	$(MAKE) run-graph-tests
	@echo "âœ… All tests completed"

run-database-tests: ## Run database-specific tests
	@echo "ðŸ—„ï¸ Running database tests..."
	cd tests/database && python -m pytest test_graph_ml_features.py -v
	@echo "âœ… Database tests completed"

run-ml-tests: ## Run ML model tests
	@echo "ðŸ¤– Running ML tests..."
	cd tests/ml && python -m pytest -v
	@echo "âœ… ML tests completed"

run-graph-tests: ## Run graph analytics tests
	@echo "ðŸ“Š Running graph tests..."
	cd tests/graph && python -m pytest -v
	@echo "âœ… Graph tests completed"

# Development targets
setup-dev: ## Setup development environment
	@echo "ðŸ› ï¸ Setting up development environment..."
	$(MAKE) install-deps
	$(MAKE) setup-database
	@echo "âœ… Development environment ready"

install-deps: ## Install dependencies
	@echo "ðŸ“¦ Installing dependencies..."
	go mod tidy
	pip install -r requirements-test.txt
	@echo "âœ… Dependencies installed"

format: ## Format code
	@echo "ðŸŽ¨ Formatting code..."
	go fmt ./...
	black tests/
	@echo "âœ… Code formatted"

lint: ## Run linters
	@echo "ðŸ” Running linters..."
	golangci-lint run ./...
	flake8 tests/
	@echo "âœ… Linting completed"

security-scan: ## Run security scans
	@echo "ðŸ”’ Running security scans..."
	gosec ./...
	safety check -r requirements-test.txt
	@echo "âœ… Security scan completed"

# Docker targets
docker-up: ## Start Docker services
	@echo "ðŸš€ Starting Docker services..."
	docker-compose up -d
	@echo "âœ… Services started"

docker-down: ## Stop Docker services
	@echo "ðŸ›‘ Stopping Docker services..."
	docker-compose down
	@echo "âœ… Services stopped"

# Service management
start-services: ## Start all services
	@echo "ðŸš€ Starting fraud detection services..."
	$(MAKE) docker-up
	@echo "âœ… Services started"

stop-services: ## Stop all services
	@echo "ðŸ›‘ Stopping fraud detection services..."
	$(MAKE) docker-down
	@echo "âœ… Services stopped"

restart-services: ## Restart all services
	@echo "ðŸ”„ Restarting services..."
	$(MAKE) stop-services
	$(MAKE) start-services
	@echo "âœ… Services restarted"

# Database management
setup-database: ## Setup database
	@echo "ðŸ—„ï¸ Setting up database..."
	docker-compose up -d postgres neo4j
	sleep 10
	$(MAKE) migrate-schema
	@echo "âœ… Database setup completed"

migrate-schema: ## Run database migrations
	@echo "ðŸ“Š Running database migrations..."
	cd services/fraud-detection-engine && go run migrations/*.go
	@echo "âœ… Migrations completed"

backup-data: ## Backup database
	@echo "ðŸ’¾ Backing up database..."
	docker-compose exec postgres pg_dump -U fraud_user fraud_db > backup_$(shell date +%Y%m%d_%H%M%S).sql
	@echo "âœ… Backup completed"

restore-data: ## Restore database from backup
	@echo "ðŸ”„ Restoring database..."
	@read -p "Enter backup file path: " backup_file; \
	docker-compose exec -T postgres psql -U fraud_user fraud_db < $$backup_file
	@echo "âœ… Restore completed"

# ML model management
train-models: ## Train ML models
	@echo "ðŸ¤– Training ML models..."
	cd scripts && python train_fraud_models.py
	@echo "âœ… Model training completed"

deploy-models: ## Deploy trained models
	@echo "ðŸš€ Deploying ML models..."
	cd scripts && python deploy_models.py
	@echo "âœ… Model deployment completed"

validate-models: ## Validate model performance
	@echo "âœ… Validating model performance..."
	cd scripts && python validate_models.py
	@echo "âœ… Model validation completed"

# Monitoring and performance
monitor-health: ## Check service health
	@echo "ðŸ¥ Checking service health..."
	curl -f http://localhost:8080/health || echo "âŒ Fraud Detection Engine unhealthy"
	@echo "âœ… Health check completed"

check-performance: ## Check performance metrics
	@echo "ðŸ“Š Checking performance metrics..."
	curl -s http://localhost:8081/metrics | grep -E "(fraud_score|detection_rate|false_positive)"
	@echo "âœ… Performance check completed"

generate-reports: ## Generate fraud detection reports
	@echo "ðŸ“Š Generating reports..."
	cd scripts && python generate_fraud_report.py
	@echo "âœ… Reports generated"

# Deployment targets
deploy-staging: ## Deploy to staging
	@echo "ðŸš€ Deploying to staging..."
	docker-compose -f docker-compose.staging.yml up -d
	@echo "âœ… Staging deployment completed"

deploy-production: ## Deploy to production
	@echo "ðŸš€ Deploying to production..."
	@echo "âš ï¸  Production deployment requires manual approval"
	@read -p "Are you sure you want to deploy to production? (y/N): " confirm; \
	if [ "$$confirm" = "y" ] || [ "$$confirm" = "Y" ]; then \
		docker-compose -f docker-compose.prod.yml up -d; \
		echo "âœ… Production deployment completed"; \
	else \
		echo "âŒ Production deployment cancelled"; \
	fi

# Cleanup targets
clean: ## Clean build artifacts
	@echo "ðŸ§¹ Cleaning build artifacts..."
	rm -rf bin/
	rm -rf __pycache__/
	rm -rf .pytest_cache/
	rm -rf models/
	docker system prune -f
	@echo "âœ… Cleanup completed"

# Development utilities
dev-shell: ## Open development shell
	docker-compose exec fraud-detection-engine /bin/bash

logs: ## View service logs
	docker-compose logs -f fraud-detection-engine

# Quick commands
quick-test: ## Quick test run
	cd tests/database && python -m pytest test_graph_ml_features.py::TestGraphMLFeatures::test_graph_based_fraud_detection -v

quick-start: ## Quick start for development
	$(MAKE) docker-up
	sleep 15
	$(MAKE) monitor-health

# CI/CD helpers
ci-test: ## Run tests in CI environment
	@echo "ðŸ¤– Running CI tests..."
	$(MAKE) lint
	$(MAKE) security-scan
	$(MAKE) test
	@echo "âœ… CI tests completed"

ci-build: ## Build in CI environment
	@echo "ðŸ¤– Running CI build..."
	$(MAKE) build
	$(MAKE) build-docker
	@echo "âœ… CI build completed"

# Version management
version: ## Show version information
	@echo "Fraud Detection Insurance v1.0.0"
	@echo "Go version: $(shell go version)"
	@echo "Docker version: $(shell docker --version)"
	@echo "Python version: $(shell python --version)"

# Default development workflow
dev: ## Start development workflow
	$(MAKE) setup-dev
	$(MAKE) quick-start
	$(MAKE) quick-test
