version: '3.8'

services:
  # PostgreSQL for fraud data and case management
  fraud-postgres:
    image: postgres:15-alpine
    container_name: fraud-postgres
    environment:
      POSTGRES_DB: fraud_db
      POSTGRES_USER: fraud_user
      POSTGRES_PASSWORD: secure_fraud_pass
      POSTGRES_INITDB_ARGS: "--auth-host=scram-sha-256"
    ports:
      - "5436:5432"
    volumes:
      - fraud_postgres_data:/var/lib/postgresql/data
      - ./infrastructure/postgres/init.sql:/docker-entrypoint-initdb.d/init.sql
    networks:
      - fraud-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U fraud_user -d fraud_db"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Neo4j for graph analytics
  fraud-neo4j:
    image: neo4j:5.9-community
    container_name: fraud-neo4j
    ports:
      - "7475:7474"
      - "7688:7687"
    environment:
      - NEO4J_AUTH=neo4j/fraud_graph_pass
      - NEO4J_PLUGINS=["apoc", "graph-data-science"]
      - NEO4J_dbms_security_procedures_unrestricted=apoc.*,gds.*
      - NEO4J_dbms_memory_heap_initial__size=512m
      - NEO4J_dbms_memory_heap_max__size=2G
    volumes:
      - fraud_neo4j_data:/data
      - fraud_neo4j_logs:/logs
      - fraud_neo4j_import:/var/lib/neo4j/import
      - fraud_neo4j_plugins:/plugins
    networks:
      - fraud-network
    healthcheck:
      test: ["CMD", "cypher-shell", "-u", "neo4j", "-p", "fraud_graph_pass", "RETURN 1"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Redis for caching and real-time scoring
  fraud-redis:
    image: redis:7-alpine
    container_name: fraud-redis
    ports:
      - "6382:6379"
    volumes:
      - fraud_redis_data:/data
    networks:
      - fraud-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 3

  # Apache Kafka for event streaming
  fraud-zookeeper:
    image: confluentinc/cp-zookeeper:7.4.0
    container_name: fraud-zookeeper
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    networks:
      - fraud-network

  fraud-kafka:
    image: confluentinc/cp-kafka:7.4.0
    container_name: fraud-kafka
    depends_on:
      - fraud-zookeeper
    ports:
      - "9095:9095"
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: fraud-zookeeper:2181
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://fraud-kafka:29092,PLAINTEXT_HOST://localhost:9095
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 1
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: 'true'
    networks:
      - fraud-network
    healthcheck:
      test: ["CMD", "kafka-topics", "--bootstrap-server", "localhost:9092", "--list"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Elasticsearch for search and analytics
  fraud-elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.8.0
    container_name: fraud-elasticsearch
    environment:
      - discovery.type=single-node
      - xpack.security.enabled=false
      - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
    ports:
      - "9203:9200"
    volumes:
      - fraud_elasticsearch_data:/usr/share/elasticsearch/data
    networks:
      - fraud-network
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:9200/_cluster/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Graph Analyzer Service
  graph-analyzer:
    build:
      context: ./services/graph-analyzer
      dockerfile: Dockerfile
    container_name: graph-analyzer
    ports:
      - "8517:8517"
    environment:
      - PORT=8517
      - POSTGRES_URL=postgres://fraud_user:secure_fraud_pass@fraud-postgres:5432/fraud_db?sslmode=disable
      - NEO4J_URL=bolt://fraud-neo4j:7687
      - NEO4J_USER=neo4j
      - NEO4J_PASSWORD=fraud_graph_pass
      - REDIS_URL=redis://fraud-redis:6379
      - KAFKA_BROKERS=fraud-kafka:29092
      - LOG_LEVEL=info
    depends_on:
      fraud-postgres:
        condition: service_healthy
      fraud-neo4j:
        condition: service_healthy
      fraud-redis:
        condition: service_healthy
      fraud-kafka:
        condition: service_healthy
    networks:
      - fraud-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8517/health"]
      interval: 15s
      timeout: 10s
      retries: 3

  # ML Scoring Service
  ml-scoring:
    build:
      context: ./services/ml-scoring
      dockerfile: Dockerfile
    container_name: ml-scoring
    ports:
      - "8518:8518"
    environment:
      - PORT=8518
      - POSTGRES_URL=postgres://fraud_user:secure_fraud_pass@fraud-postgres:5432/fraud_db?sslmode=disable
      - REDIS_URL=redis://fraud-redis:6379
      - ELASTICSEARCH_URL=http://fraud-elasticsearch:9200
      - MODEL_PATH=/app/models
    volumes:
      - fraud_ml_models:/app/models
    depends_on:
      fraud-postgres:
        condition: service_healthy
      fraud-redis:
        condition: service_healthy
      fraud-elasticsearch:
        condition: service_healthy
    networks:
      - fraud-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8518/health"]
      interval: 15s
      timeout: 10s
      retries: 3

  # Case Management Service
  case-manager:
    build:
      context: ./services/case-manager
      dockerfile: Dockerfile
    container_name: case-manager
    ports:
      - "8519:8519"
    environment:
      - PORT=8519
      - POSTGRES_URL=postgres://fraud_user:secure_fraud_pass@fraud-postgres:5432/fraud_db?sslmode=disable
      - KAFKA_BROKERS=fraud-kafka:29092
      - GRAPH_ANALYZER_URL=http://graph-analyzer:8517
      - ML_SCORING_URL=http://ml-scoring:8518
    depends_on:
      fraud-postgres:
        condition: service_healthy
      fraud-kafka:
        condition: service_healthy
      graph-analyzer:
        condition: service_healthy
      ml-scoring:
        condition: service_healthy
    networks:
      - fraud-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8519/health"]
      interval: 15s
      timeout: 10s
      retries: 3

  # Entity Resolution Service
  entity-resolver:
    build:
      context: ./services/entity-resolver
      dockerfile: Dockerfile
    container_name: entity-resolver
    ports:
      - "8520:8520"
    environment:
      - PORT=8520
      - POSTGRES_URL=postgres://fraud_user:secure_fraud_pass@fraud-postgres:5432/fraud_db?sslmode=disable
      - NEO4J_URL=bolt://fraud-neo4j:7687
      - NEO4J_USER=neo4j
      - NEO4J_PASSWORD=fraud_graph_pass
      - ELASTICSEARCH_URL=http://fraud-elasticsearch:9200
    depends_on:
      fraud-postgres:
        condition: service_healthy
      fraud-neo4j:
        condition: service_healthy
      fraud-elasticsearch:
        condition: service_healthy
    networks:
      - fraud-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8520/health"]
      interval: 15s
      timeout: 10s
      retries: 3

  # Prometheus for metrics
  fraud-prometheus:
    image: prom/prometheus:latest
    container_name: fraud-prometheus
    ports:
      - "9094:9090"
    volumes:
      - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml
      - fraud_prometheus_data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/etc/prometheus/console_libraries'
      - '--web.console.templates=/etc/prometheus/consoles'
      - '--storage.tsdb.retention.time=200h'
      - '--web.enable-lifecycle'
    networks:
      - fraud-network

  # Grafana for visualization
  fraud-grafana:
    image: grafana/grafana:latest
    container_name: fraud-grafana
    ports:
      - "3004:3000"
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=fraud_admin
    volumes:
      - fraud_grafana_data:/var/lib/grafana
      - ./monitoring/grafana/dashboards:/etc/grafana/provisioning/dashboards
      - ./monitoring/grafana/datasources:/etc/grafana/provisioning/datasources
    networks:
      - fraud-network

  # Jaeger for distributed tracing
  fraud-jaeger:
    image: jaegertracing/all-in-one:latest
    container_name: fraud-jaeger
    ports:
      - "16688:16686"
      - "14270:14268"
    environment:
      - COLLECTOR_OTLP_ENABLED=true
    networks:
      - fraud-network

volumes:
  fraud_postgres_data:
    driver: local
  fraud_neo4j_data:
    driver: local
  fraud_neo4j_logs:
    driver: local
  fraud_neo4j_import:
    driver: local
  fraud_neo4j_plugins:
    driver: local
  fraud_redis_data:
    driver: local
  fraud_elasticsearch_data:
    driver: local
  fraud_ml_models:
    driver: local
  fraud_prometheus_data:
    driver: local
  fraud_grafana_data:
    driver: local

networks:
  fraud-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.27.0.0/16
