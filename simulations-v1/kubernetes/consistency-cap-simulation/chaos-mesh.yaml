apiVersion: v1
kind: ServiceAccount
metadata:
  name: chaos-controller
  namespace: consistency-simulation
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: chaos-controller
rules:
- apiGroups: [""]
  resources: ["pods", "services", "endpoints"]
  verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
- apiGroups: ["apps"]
  resources: ["deployments", "statefulsets"]
  verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
- apiGroups: ["chaos-mesh.org"]
  resources: ["*"]
  verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: chaos-controller
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: chaos-controller
subjects:
- kind: ServiceAccount
  name: chaos-controller
  namespace: consistency-simulation
---
apiVersion: chaos-mesh.org/v1alpha1
kind: NetworkChaos
metadata:
  name: network-partition-etcd
  namespace: consistency-simulation
spec:
  action: partition
  mode: fixed
  selector:
    namespaces:
    - consistency-simulation
    labelSelectors:
      app: etcd
  direction: both
  target:
    mode: fixed
    selector:
      namespaces:
      - consistency-simulation
      labelSelectors:
        app: etcd
  duration: "300s"
---
apiVersion: chaos-mesh.org/v1alpha1
kind: PodChaos
metadata:
  name: etcd-leader-failure
  namespace: consistency-simulation
spec:
  action: pod-kill
  mode: fixed-percent
  value: "33"
  selector:
    namespaces:
    - consistency-simulation
    labelSelectors:
      app: etcd
  duration: "60s"
---
apiVersion: chaos-mesh.org/v1alpha1
kind: NetworkChaos
metadata:
  name: mongodb-replica-lag
  namespace: consistency-simulation
spec:
  action: delay
  mode: all
  selector:
    namespaces:
    - consistency-simulation
    labelSelectors:
      app: mongodb
  delay:
    latency: "1000ms"
    correlation: "100"
    jitter: "0ms"
  duration: "300s"
---
apiVersion: chaos-mesh.org/v1alpha1
kind: TimeChaos
metadata:
  name: clock-skew-simulation
  namespace: consistency-simulation
spec:
  mode: fixed-percent
  value: "50"
  selector:
    namespaces:
    - consistency-simulation
    labelSelectors:
      app: etcd
  timeOffset: "60s"
  duration: "300s"
---
apiVersion: chaos-mesh.org/v1alpha1
kind: StressChaos
metadata:
  name: memory-pressure
  namespace: consistency-simulation
spec:
  mode: fixed-percent
  value: "33"
  selector:
    namespaces:
    - consistency-simulation
    labelSelectors:
      app: mongodb
  stressors:
    memory:
      workers: 1
      size: "256MB"
  duration: "300s"
---
apiVersion: chaos-mesh.org/v1alpha1
kind: IOChaos
metadata:
  name: disk-latency
  namespace: consistency-simulation
spec:
  action: latency
  mode: all
  selector:
    namespaces:
    - consistency-simulation
    labelSelectors:
      app: etcd
  volumePath: /etcd-data
  path: "**/*"
  delay: "100ms"
  percent: 50
  duration: "300s"
