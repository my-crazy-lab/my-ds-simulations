# RegTech Automated Reporting Makefile
# Regulatory compliance and audit trail automation

.PHONY: help build test clean deploy docker-build docker-up docker-down \
        run-tests run-compliance-tests run-database-tests run-audit-tests \
        setup-dev install-deps format lint security-scan \
        start-services stop-services restart-services \
        backup-data restore-data migrate-schema \
        generate-reports validate-reports submit-reports \
        deploy-staging deploy-production \
        monitor-health check-compliance audit-trail

# Default target
help: ## Show this help message
	@echo "RegTech Automated Reporting - Available Commands:"
	@echo "================================================"
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "\033[36m%-30s\033[0m %s\n", $$1, $$2}'

# Build targets
build: ## Build all RegTech services
	@echo "ðŸ”¨ Building RegTech services..."
	cd services/reporting-engine && go build -o ../../bin/reporting-engine .
	@echo "âœ… Build completed"

build-docker: ## Build Docker images
	@echo "ðŸ³ Building Docker images..."
	docker-compose build
	@echo "âœ… Docker images built"

# Test targets
test: ## Run all tests
	@echo "ðŸ§ª Running all tests..."
	$(MAKE) run-database-tests
	$(MAKE) run-compliance-tests
	$(MAKE) run-audit-tests
	@echo "âœ… All tests completed"

run-database-tests: ## Run database-specific tests
	@echo "ðŸ—„ï¸ Running database tests..."
	cd tests/database && python -m pytest -v
	@echo "âœ… Database tests completed"

run-compliance-tests: ## Run compliance tests
	@echo "ðŸ“‹ Running compliance tests..."
	cd tests/compliance && python -m pytest -v
	@echo "âœ… Compliance tests completed"

run-audit-tests: ## Run audit tests
	@echo "ðŸ” Running audit tests..."
	cd tests/audit && python -m pytest -v
	@echo "âœ… Audit tests completed"

# Development targets
setup-dev: ## Setup development environment
	@echo "ðŸ› ï¸ Setting up development environment..."
	$(MAKE) install-deps
	$(MAKE) setup-database
	@echo "âœ… Development environment ready"

install-deps: ## Install dependencies
	@echo "ðŸ“¦ Installing dependencies..."
	go mod tidy
	pip install -r requirements-test.txt
	@echo "âœ… Dependencies installed"

format: ## Format code
	@echo "ðŸŽ¨ Formatting code..."
	go fmt ./...
	black tests/
	@echo "âœ… Code formatted"

lint: ## Run linters
	@echo "ðŸ” Running linters..."
	golangci-lint run ./...
	flake8 tests/
	@echo "âœ… Linting completed"

security-scan: ## Run security scans
	@echo "ðŸ”’ Running security scans..."
	gosec ./...
	safety check -r requirements-test.txt
	@echo "âœ… Security scan completed"

# Docker targets
docker-up: ## Start Docker services
	@echo "ðŸš€ Starting Docker services..."
	docker-compose up -d
	@echo "âœ… Services started"

docker-down: ## Stop Docker services
	@echo "ðŸ›‘ Stopping Docker services..."
	docker-compose down
	@echo "âœ… Services stopped"

# Service management
start-services: ## Start all services
	@echo "ðŸš€ Starting RegTech services..."
	$(MAKE) docker-up
	@echo "âœ… Services started"

stop-services: ## Stop all services
	@echo "ðŸ›‘ Stopping RegTech services..."
	$(MAKE) docker-down
	@echo "âœ… Services stopped"

restart-services: ## Restart all services
	@echo "ðŸ”„ Restarting services..."
	$(MAKE) stop-services
	$(MAKE) start-services
	@echo "âœ… Services restarted"

# Database management
setup-database: ## Setup database
	@echo "ðŸ—„ï¸ Setting up database..."
	docker-compose up -d postgres
	sleep 10
	$(MAKE) migrate-schema
	@echo "âœ… Database setup completed"

migrate-schema: ## Run database migrations
	@echo "ðŸ“Š Running database migrations..."
	cd services/reporting-engine && go run migrations/*.go
	@echo "âœ… Migrations completed"

backup-data: ## Backup database
	@echo "ðŸ’¾ Backing up database..."
	docker-compose exec postgres pg_dump -U regtech_user regtech_db > backup_$(shell date +%Y%m%d_%H%M%S).sql
	@echo "âœ… Backup completed"

restore-data: ## Restore database from backup
	@echo "ðŸ”„ Restoring database..."
	@read -p "Enter backup file path: " backup_file; \
	docker-compose exec -T postgres psql -U regtech_user regtech_db < $$backup_file
	@echo "âœ… Restore completed"

# Reporting functions
generate-reports: ## Generate regulatory reports
	@echo "ðŸ“Š Generating regulatory reports..."
	cd scripts && python generate_regulatory_reports.py
	@echo "âœ… Reports generated"

validate-reports: ## Validate report formats
	@echo "âœ… Validating report formats..."
	cd scripts && python validate_reports.py
	@echo "âœ… Report validation completed"

submit-reports: ## Submit reports to regulators
	@echo "ðŸ“¤ Submitting reports to regulators..."
	cd scripts && python submit_reports.py
	@echo "âœ… Reports submitted"

# Monitoring and compliance
monitor-health: ## Check service health
	@echo "ðŸ¥ Checking service health..."
	curl -f http://localhost:8080/health || echo "âŒ Reporting Engine unhealthy"
	@echo "âœ… Health check completed"

check-compliance: ## Run compliance checks
	@echo "ðŸ“‹ Running compliance checks..."
	cd tests && python -m pytest compliance/ -v
	@echo "âœ… Compliance checks completed"

audit-trail: ## Generate audit trail
	@echo "ðŸ” Generating audit trail..."
	cd scripts && python generate_audit_trail.py
	@echo "âœ… Audit trail generated"

# Deployment targets
deploy-staging: ## Deploy to staging
	@echo "ðŸš€ Deploying to staging..."
	docker-compose -f docker-compose.staging.yml up -d
	@echo "âœ… Staging deployment completed"

deploy-production: ## Deploy to production
	@echo "ðŸš€ Deploying to production..."
	@echo "âš ï¸  Production deployment requires manual approval"
	@read -p "Are you sure you want to deploy to production? (y/N): " confirm; \
	if [ "$$confirm" = "y" ] || [ "$$confirm" = "Y" ]; then \
		docker-compose -f docker-compose.prod.yml up -d; \
		echo "âœ… Production deployment completed"; \
	else \
		echo "âŒ Production deployment cancelled"; \
	fi

# Cleanup targets
clean: ## Clean build artifacts
	@echo "ðŸ§¹ Cleaning build artifacts..."
	rm -rf bin/
	rm -rf __pycache__/
	rm -rf .pytest_cache/
	docker system prune -f
	@echo "âœ… Cleanup completed"

# Development utilities
dev-shell: ## Open development shell
	docker-compose exec reporting-engine /bin/bash

logs: ## View service logs
	docker-compose logs -f reporting-engine

# Quick commands
quick-test: ## Quick test run
	cd tests/database && python -m pytest -v

quick-start: ## Quick start for development
	$(MAKE) docker-up
	sleep 15
	$(MAKE) monitor-health

# CI/CD helpers
ci-test: ## Run tests in CI environment
	@echo "ðŸ¤– Running CI tests..."
	$(MAKE) lint
	$(MAKE) security-scan
	$(MAKE) test
	@echo "âœ… CI tests completed"

ci-build: ## Build in CI environment
	@echo "ðŸ¤– Running CI build..."
	$(MAKE) build
	$(MAKE) build-docker
	@echo "âœ… CI build completed"

# Version management
version: ## Show version information
	@echo "RegTech Automated Reporting v1.0.0"
	@echo "Go version: $(shell go version)"
	@echo "Docker version: $(shell docker --version)"
	@echo "Python version: $(shell python --version)"

# Default development workflow
dev: ## Start development workflow
	$(MAKE) setup-dev
	$(MAKE) quick-start
	$(MAKE) quick-test
